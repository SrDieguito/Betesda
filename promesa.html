<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard – Promesa de Fe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.fade { animation: fade .6s ease both }
@keyframes fade {
  from { opacity:0; transform:translateY(15px) }
  to { opacity:1; transform:translateY(0) }
}
</style>
</head>

<body class="bg-gray-100 min-h-screen p-4">

<div class="max-w-7xl mx-auto space-y-6 fade">

<!-- HEADER -->
<div class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row justify-between items-center">
  <div>
    <h1 class="text-3xl font-bold">Promesa de Fe</h1>
    <p class="text-gray-600">Dashboard mensual – Misiones</p>
  </div>

  <input id="mes"
    type="month"
    class="p-2 border rounded-lg">
</div>

<!-- KPIs -->
<div class="grid md:grid-cols-4 gap-4">
  <div class="bg-white p-6 rounded-xl shadow text-center">
    <div class="text-3xl font-bold text-[#BF9B30]" id="total">$0</div>
    <div class="text-gray-600">Total mensual</div>
  </div>

  <div class="bg-white p-6 rounded-xl shadow text-center">
    <div class="text-3xl font-bold" id="meta">$0</div>
    <div class="text-gray-600">Meta</div>
  </div>

  <div class="bg-white p-6 rounded-xl shadow text-center">
    <div class="text-3xl font-bold" id="porcentaje">0%</div>
    <div class="text-gray-600">Avance</div>
  </div>

  <div class="bg-white p-6 rounded-xl shadow p-4">
    <div class="w-full bg-gray-200 rounded-full h-4">
      <div id="barra"
        class="bg-[#BF9B30] h-4 rounded-full transition-all"></div>
    </div>
  </div>
</div>

<!-- INGRESO -->
<div class="bg-white rounded-xl shadow p-6 grid md:grid-cols-5 gap-4">
  <input id="monto" type="number" placeholder="Monto" class="p-3 border rounded">
  <select id="dia" class="p-3 border rounded">
    <option>Jueves</option>
    <option>Domingo</option>
  </select>
  <input id="metaInput" type="number" placeholder="Meta mensual" class="p-3 border rounded">
  <button onclick="guardarMeta()" class="bg-gray-800 text-white rounded">Guardar Meta</button>
  <button onclick="agregar()" class="bg-[#BF9B30] text-white rounded">Agregar</button>
</div>

<!-- GRAFICOS -->
<div class="grid md:grid-cols-2 gap-6">
  <div class="bg-white p-6 rounded-xl shadow">
    <canvas id="graficoDias"></canvas>
  </div>
  <div class="bg-white p-6 rounded-xl shadow">
    <canvas id="graficoProgreso"></canvas>
  </div>
</div>

<!-- EXPORT -->
<div class="text-right">
  <button onclick="exportarCSV()"
    class="bg-black text-white px-6 py-2 rounded hover:bg-gray-700">
    Exportar CSV
  </button>
</div>

</div>

<script>
const storage = JSON.parse(localStorage.getItem("promesaFE")) || {};
const mesInput = document.getElementById("mes");

const hoy = new Date().toISOString().slice(0,7);
mesInput.value = hoy;

let chart1, chart2;

function getMes() {
  if (!storage[mesInput.value])
    storage[mesInput.value] = { meta: 0, registros: [] };
  return storage[mesInput.value];
}

function guardarMeta() {
  getMes().meta = Number(metaInput.value);
  persistir();
  render();
}

function agregar() {
  const monto = Number(document.getElementById("monto").value);
  const dia = document.getElementById("dia").value;
  if (!monto) return;

  getMes().registros.push({
    fecha: new Date().toISOString().slice(0,10),
    dia, monto
  });

  document.getElementById("monto").value = "";
  persistir();
  render();
}

function render() {
  const { meta, registros } = getMes();
  const total = registros.reduce((a,b)=>a+b.monto,0);
  const porcentaje = meta ? Math.min(total/meta*100,100) : 0;

  totalEl.textContent = `$${total.toFixed(2)}`;
  metaEl.textContent = `$${meta.toFixed(2)}`;
  porcentajeEl.textContent = porcentaje.toFixed(1)+"%";
  barra.style.width = porcentaje+"%";
  metaInput.value = meta || "";

  const jueves = registros.filter(r=>r.dia==="Jueves").reduce((a,b)=>a+b.monto,0);
  const domingo = registros.filter(r=>r.dia==="Domingo").reduce((a,b)=>a+b.monto,0);

  if (chart1) chart1.destroy();
  chart1 = new Chart(graficoDias, {
    type:"bar",
    data:{
      labels:["Jueves","Domingo"],
      datasets:[{ data:[jueves,domingo], backgroundColor:["#BF9B30","#111827"] }]
    }
  });

  if (chart2) chart2.destroy();
  chart2 = new Chart(graficoProgreso, {
    type:"doughnut",
    data:{
      labels:["Alcanzado","Faltante"],
      datasets:[{ data:[total, Math.max(meta-total,0)],
        backgroundColor:["#BF9B30","#e5e7eb"] }]
    }
  });
}

function exportarCSV() {
  const { registros } = getMes();
  let csv = "Fecha,Dia,Monto\n";
  registros.forEach(r=>csv+=`${r.fecha},${r.dia},${r.monto}\n`);

  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `promesa-fe-${mesInput.value}.csv`;
  a.click();
}

function persistir() {
  localStorage.setItem("promesaFE", JSON.stringify(storage));
}

mesInput.onchange = render;
render();
</script>

</body>
</html>
