<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard – Promesa de Fe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.fade {
  animation: fade .5s ease both;
}
@keyframes fade {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
</style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-7xl mx-auto space-y-8 fade">

<!-- HEADER -->
<header class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row justify-between items-center gap-4">
  <div>
    <h1 class="text-3xl font-bold text-gray-800">Promesa de Fe</h1>
    <p class="text-gray-500">Ofrenda misionera · Dashboard mensual</p>
  </div>
  <input id="mes" type="month" class="border rounded-lg p-2 text-lg">
</header>

<!-- KPIs -->
<section class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="bg-white rounded-xl shadow p-6 text-center">
    <div id="total" class="text-3xl font-bold text-[#BF9B30]">$0</div>
    <p class="text-gray-500 mt-1">Total Recolectado</p>
  </div>

  <div class="bg-white rounded-xl shadow p-6 text-center">
    <div id="meta" class="text-3xl font-bold text-gray-800">$0</div>
    <p class="text-gray-500 mt-1">Meta Mensual</p>
  </div>

  <div class="bg-white rounded-xl shadow p-6 text-center">
    <div id="porcentaje" class="text-3xl font-bold text-gray-800">0%</div>
    <p class="text-gray-500 mt-1">Progreso</p>
  </div>

  <div class="bg-white rounded-xl shadow p-6">
    <div class="w-full bg-gray-200 rounded-full h-4">
      <div id="barra" class="bg-[#BF9B30] h-4 rounded-full transition-all"></div>
    </div>
  </div>
</section>

<!-- FORMULARIO -->
<section class="bg-white rounded-xl shadow p-6">
  <h2 class="text-xl font-semibold mb-4">Registrar Ofrenda</h2>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <input id="monto" type="number" placeholder="Monto ($)" class="border p-3 rounded-lg">
    
    <select id="dia" class="border p-3 rounded-lg">
      <option value="Jueves">Jueves</option>
      <option value="Domingo">Domingo</option>
    </select>

    <input id="metaInput" type="number" placeholder="Meta mensual" class="border p-3 rounded-lg">

    <button id="btnMeta"
      class="bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition">
      Guardar Meta
    </button>

    <button id="btnAgregar"
      class="bg-[#BF9B30] text-white rounded-lg hover:bg-yellow-600 transition">
      Agregar Ofrenda
    </button>
  </div>
</section>

<!-- GRAFICOS -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white rounded-xl shadow p-6">
    <h3 class="font-semibold mb-3">Ofrendas por Día</h3>
    <canvas id="graficoDias"></canvas>
  </div>

  <div class="bg-white rounded-xl shadow p-6">
    <h3 class="font-semibold mb-3">Progreso Mensual</h3>
    <canvas id="graficoProgreso"></canvas>
  </div>
</section>

<!-- EXPORT -->
<section class="text-right">
  <button id="btnExport"
    class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">
    Exportar CSV
  </button>
</section>

</div>

<script>
/* =======================
   ESTADO GLOBAL
======================= */
const STORAGE_KEY = "promesaFE";
const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

const mesInput = document.getElementById("mes");
const totalEl = document.getElementById("total");
const metaEl = document.getElementById("meta");
const porcentajeEl = document.getElementById("porcentaje");
const barra = document.getElementById("barra");
const metaInput = document.getElementById("metaInput");

let chartDias, chartProgreso;

/* =======================
   INIT
======================= */
mesInput.value = new Date().toISOString().slice(0,7);
mesInput.addEventListener("change", render);
document.getElementById("btnAgregar").onclick = agregar;
document.getElementById("btnMeta").onclick = guardarMeta;
document.getElementById("btnExport").onclick = exportarCSV;

render();

/* =======================
   FUNCIONES
======================= */
function getMes() {
  const mes = mesInput.value;
  if (!data[mes]) data[mes] = { meta: 0, registros: [] };
  return data[mes];
}

function guardarMeta() {
  getMes().meta = Number(metaInput.value || 0);
  persistir();
  render();
}

function agregar() {
  const monto = Number(document.getElementById("monto").value);
  const dia = document.getElementById("dia").value;
  if (!monto) return;

  getMes().registros.push({
    fecha: new Date().toISOString().slice(0,10),
    dia,
    monto
  });

  document.getElementById("monto").value = "";
  persistir();
  render();
}

function render() {
  const { meta, registros } = getMes();
  const total = registros.reduce((a,b)=>a+b.monto,0);
  const porcentaje = meta ? Math.min(total / meta * 100, 100) : 0;

  totalEl.textContent = `$${total.toFixed(2)}`;
  metaEl.textContent = `$${meta.toFixed(2)}`;
  porcentajeEl.textContent = porcentaje.toFixed(1) + "%";
  barra.style.width = porcentaje + "%";
  metaInput.value = meta || "";

  const jueves = registros.filter(r=>r.dia==="Jueves").reduce((a,b)=>a+b.monto,0);
  const domingo = registros.filter(r=>r.dia==="Domingo").reduce((a,b)=>a+b.monto,0);

  if (chartDias) chartDias.destroy();
  chartDias = new Chart(graficoDias, {
    type:"bar",
    data:{
      labels:["Jueves","Domingo"],
      datasets:[{
        data:[jueves,domingo],
        backgroundColor:["#BF9B30","#1f2937"]
      }]
    },
    options:{ responsive:true }
  });

  if (chartProgreso) chartProgreso.destroy();
  chartProgreso = new Chart(graficoProgreso, {
    type:"doughnut",
    data:{
      labels:["Recolectado","Faltante"],
      datasets:[{
        data:[total, Math.max(meta-total,0)],
        backgroundColor:["#BF9B30","#e5e7eb"]
      }]
    },
    options:{ responsive:true }
  });
}

function exportarCSV() {
  const { registros } = getMes();
  let csv = "Fecha,Dia,Monto\n";
  registros.forEach(r => csv += `${r.fecha},${r.dia},${r.monto}\n`);

  const blob = new Blob([csv], { type:"text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `promesa-fe-${mesInput.value}.csv`;
  a.click();
}

function persistir() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
</script>

</body>
</html>
